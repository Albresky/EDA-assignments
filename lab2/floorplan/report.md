# 实验报告：Floorplan 算法实现

## 引言

本次实验旨在使用 B\*-树表示和模拟退火算法实现芯片 Floorplanning。目标是在预定义的芯片外形轮廓内放置一组矩形模块（块），同时最小化总面积和线长。本报告详细分析了理论背景、整体设计流程，并解释了我们实现中使用的关键函数。

## 理论背景

### Floorplanning 概述

Floorplanning 是超大规模集成电路（VLSI）物理设计中的关键步骤。它涉及在芯片上排列各种功能块，以优化面积、线长、时序等性能指标，同时满足纵横比、固定外形轮廓等约束。

### B\*-树表示

B\*-树是一种用于表示非切片（non-slicing）Floorplan 的有效数据结构。树中的每个节点对应一个块，树结构编码了块之间的几何关系：

- **左子节点**：放置在父块的右侧。
- **右子节点**：放置在父块的上方。

这种表示方式确保了 Floorplan 的紧凑性，并在优化过程中保持块的相对位置。

**B\*-树的优点**：

- 高效的紧凑算法。
- 支持多种优化扰动操作。
- 由于其灵活性，适用于模拟退火算法。

### 模拟退火算法

模拟退火（Simulated Annealing，SA）是一种受冶金退火过程启发的概率优化技术，常用于在大型搜索空间中找到全局最小值。

**关键概念**：

- **温度**：控制接受较差解的概率。
- **冷却计划**：逐渐降低温度以细化搜索。
- **扰动**：应用随机变化以探索解决方案空间。

**SA 算法步骤**：

1. **初始化**：以初始解和高温度开始。
2. **迭代**：在每个温度下：
   - 应用扰动生成新解。
   - 计算成本差异。
   - 根据接受概率决定是否接受新解。
3. **冷却**：根据冷却计划降低温度。
4. **终止**：当温度足够低或达到预定迭代次数时停止。

## 整体设计流程

我们的 Floorplanning 实现包含以下步骤：

1. **输入解析**：从输入文件读取块和网络列表信息。
2. **数据结构初始化**：为块、终端、网络和外形轮廓创建对象。
3. **初始 Floorplan 构建**：构建初始 B\*-树并计算块的位置。
4. **模拟退火优化**：使用 SA 优化 Floorplan。
5. **结果输出**：将最终 Floorplan 写入文件并进行可视化。

### 输入解析

#### 块文件解析（`parse_dotblock`）

- **目的**：读取块的尺寸、块和终端的数量，以及外形轮廓的大小。
- **过程**：
  - 提取外形轮廓尺寸并初始化 `Outline` 对象。
  - 解析块信息，创建具有相应宽度和高度的 `Block` 对象。
  - 解析终端信息，创建具有固定位置的 `Terminal` 对象。

#### 网络列表文件解析（`parse_dotnet`）

- **目的**：读取块和终端之间的网络连接。
- **过程**：
  - 解析网络，每个网络包含连接的块和终端列表。
  - 创建 `Net` 对象以表示 Floorplan 中的连通性。

### 数据结构初始化

- **Blocks（块）**：存储在 `Blocks` 容器中，便于访问和操作。
- **Terminals（终端）**：存储在 `Terminals` 容器中。
- **Nets（网络）**：存储在 `Nets` 容器中。
- **Outline（外形轮廓）**：表示芯片的边界约束。

### 初始 Floorplan 构建

- **B\*-树初始化**（`BStarTree.initialize`）：
  - 通过确定性或随机方式创建初始 Floorplan。
  - 在块之间分配父节点、左子节点和右子节点关系。
- **紧凑化**（`BStarTree.pack`）：
  - 根据 B\*-树结构计算每个块的实际位置（`x`，`y`）。

### 模拟退火优化

- **扰动操作**（`BStarTree.perturb`）：
  - 随机应用以下操作之一：
    - **旋转**：交换块的宽度和高度。
    - **交换**：在树中交换两个块的位置。
    - **移动**：将一个块移动到树中的不同位置。
- **成本计算**（`BStarTree.calculate_cost`）：
  - **面积**：块占用的总面积。
  - **线长**：所有网络的半周长总和。
  - **成本函数**：面积和线长的加权和（如 `Cost = Area + λ * Wirelength`）。
- **接受准则**：
  - 接受具有更低成本的新解。
  - 以概率 `P = exp(-ΔCost / Temperature)` 接受较差的解。
- **冷却计划**：
  - 使用 `Temperature = α * Temperature` 更新温度，其中 `α` 为 0 到 1 之间的冷却率。

### 结果输出

- **输出文件**：
  - 包含最终的成本、面积、线长、尺寸和块的位置。
- **可视化**（`visualize`）：
  - 从输出文件读取最终 Floorplan。
  - 使用 matplotlib 生成 Floorplan 的图形表示。
  - 将可视化结果保存为图像。

## 使用的函数及其作用

### `parse_dotblock`

- **功能**：
  - 读取块文件。
  - 提取外形轮廓尺寸（宽度和高度）。
  - 解析块信息：
    - **块名**
    - **宽度**
    - **高度**
  - 解析终端信息：
    - **终端名**
    - **固定位置（`x`，`y`）**
- **目的**：
  - 使用解析的数据初始化 `Outline`、`Blocks` 和 `Terminals` 对象。

### `parse_dotnet`

- **功能**：
  - 读取网络列表文件。
  - 对于每个网络，识别连接的块和终端。
- **目的**：
  - 构建块和终端之间的连通图。
  - 为线长计算初始化 `Nets` 对象。

### `BStarTree` 类

#### 关键方法：

- **`initialize`**：
  - 构建初始 B\*-树 Floorplan。
  - 在块之间分配父节点和子节点关系。

- **`pack`**：
  - 根据 B\*-树计算每个块的位置。
  - 确保初始配置中块之间没有重叠。

- **`perturb`**：
  - 随机选择并应用一种扰动操作（旋转、交换、移动）。
  - 修改 B\*-树以探索解决方案空间。

- **`calculate_cost`**：
  - 计算块占用的总面积。
  - 根据网络计算线长。
  - 返回用于 SA 优化的综合成本。

- **`simulate_annealing`**：
  - 控制 SA 优化循环。
  - 调整温度并应用接受准则。
  - 记录找到的最佳解决方案。

- **`check_out_of_outline`**：
  - 验证所有块是否在芯片的外形轮廓内。
  - 如果布局有效，返回 `True`。

- **`check_overlap`**：
  - 检查块之间是否存在重叠。
  - 确保布局可行。

- **`revert`**：
  - 如果当前扰动未被接受，则恢复到先前的 Floorplan 状态。
  - 维护 B\*-树的完整性。

### `visualize`

- **功能**：
  - 从输出文件读取最终的 Floorplan。
  - 将每个块绘制为具有相应尺寸和位置的矩形。
  - 为块分配随机颜色以便区分。
- **目的**：
  - 提供 Floorplan 的可视化表示。
  - 有助于验证布局的正确性。
- **输出**：
  - 将生成的图像保存为文件（如 `floorplan_output.png`）。

## 实验结果

在运行模拟退火算法后，我们为提供的测试用例获得了优化的 Floorplan。该算法成功地最小化了面积和线长，同时满足了外形轮廓的约束。

**示例 Floorplan 可视化**：

![优化后的 Floorplan](../../images/lab1.2_floorplan_results2_visualized.png)

*图1：优化后的 Floorplan 可视化结果。*

**性能指标**：

- **总成本**：面积和线长的组合。
- **总线长**：所有网络的半周长之和。
- **总面积**：块所占用的面积。
- **外形尺寸**：确保 Floorplan 适合给定的外形轮廓。

## 结论

在本次实验中，我们使用 B\*-树表示和模拟退火算法实现了 Floorplanning 解决方案。B\*-树为表示和操作 Floorplan 提供了有效的方式，模拟退火使我们能够有效地探索解决方案空间，以找到近似最优的布局。

**主要收获**：

- B\*-树和 SA 的结合在解决 Floorplanning 问题上非常有效。
- 扰动方法的正确实现对于 SA 算法的性能至关重要。
- 可视化 Floorplan 有助于调试并验证算法的正确性。

**未来改进**：

- 实现更先进的冷却计划以获得更好的收敛性。
- 探索更多成本函数组件，例如时序或功耗。
- 优化数据结构，以便在更大的设计上实现更快的计算。

## 参考文献

- [1] S. N. Adya and I. L. Markov, "Fixed-outline Floorplanning through Better Local Search," **International Conference on Computer Design (ICCD)**, 2001.
- [2] N. Sherwani, **Algorithms for VLSI Physical Design Automation**, Springer, 2002.
- [3] 丛京生，萨拉费扎德，"芯片布局设计与优化"，**IEEE Design & Test of Computers**，第14卷，第2期，页码12–25，1997年。
- [4] **ChatGPT o1 preview**
